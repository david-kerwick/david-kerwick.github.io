---
layout: post
title: Ubuntu can't apt-get upgrade because boot partition is full
date: '2014-04-23T21:11:00.001+01:00'
author: David
tags: 
modified_time: '2014-04-23T21:13:42.932+01:00'
blogger_id: tag:blogger.com,1999:blog-2027514548288128942.post-2573224521948148034
blogger_orig_url: http://davidkerwick.blogspot.com/2014/04/ubuntu-cant-apt-get-upgrade-because.html
---

<div class="p1">When trying to do an upgrade I got the error below</div><div class="p1"><br /></div><pre class="brush:bash">sudo apt-get upgrade<br />Reading package lists... Done<br />Building dependency tree       <br />Reading state information... Done<br />You might want to run 'apt-get -f install' to correct these.<br />The following packages have unmet dependencies:<br /> linux-server : Depends: linux-headers-server (= 3.2.0.55.65) but 3.2.0.60.71 is installed<br /><br />E: Unmet dependencies. Try using -f.<br /></pre><div class="p1"><br /></div><div class="p1">When you run sudo apt-get -f install as suggested you might get something like</div><div class="p1"><br /></div><pre class="brush:bash"><br />sudo apt-get -f install<br />gzip: stdout: No space left on device<br />E: mkinitramfs failure cpio 141 gzip 1<br />update-initramfs: failed for /boot/initrd.img-3.2.0-60-generic with 1.<br />run-parts: /etc/kernel/postinst.d/initramfs-tools exited with return code 1<br />Failed to process /etc/kernel/postinst.d at /var/lib/dpkg/info/linux-image-3.2.0-60-generic.postinst line 1010.<br />dpkg: error processing linux-image-3.2.0-60-generic (--configure):<br /> subprocess installed post-installation script returned error exit status 2<br />Setting up linux-image-server (3.2.0.55.65) ...<br />Setting up linux-headers-server (3.2.0.60.71) ...<br />dpkg: dependency problems prevent configuration of linux-server:<br /> linux-server depends on linux-headers-server (= 3.2.0.55.65); however:<br />  Version of linux-headers-server on system is 3.2.0.60.71.<br />dpkg: error processing linux-server (--configure):<br /> dependency problems - leaving unconfigured<br />No apport report written because the error message indicates its a followup error from a previous failure.<br />                                                                                 Errors were encountered while processing:<br /> linux-image-3.2.0-60-generic<br /> linux-server<br />E: Sub-process /usr/bin/dpkg returned an error code (1)<br /></pre><div class="p1"><br /></div><div class="p1"><br /></div><div class="p1">If you do a df you will probably see your boot partition is full.</div><div class="p1"><br /></div><div class="p1">Freeing up space seems to be no fun, to find the list of old images</div><div class="p1"><br /></div><pre class="brush:bash">sudo dpkg --list | grep linux-image<br /><br />ii  linux-image-3.2.0-41-generic     3.2.0-41.66                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-43-generic     3.2.0-43.68                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-44-generic     3.2.0-44.69                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-45-generic     3.2.0-45.70                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-48-generic     3.2.0-48.74                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-51-generic     3.2.0-51.77                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-52-generic     3.2.0-52.78                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-53-generic     3.2.0-53.81                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />ii  linux-image-3.2.0-54-generic     3.2.0-54.82                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />iF  linux-image-3.2.0-55-generic     3.2.0-55.85                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />iF  linux-image-3.2.0-56-generic     3.2.0-56.86                  Linux kernel image for version 3.2.0 on 64 bit x86 SMP<br />iU  linux-image-server               3.2.0.55.65                  Linux kernel image on Server Equipment.<br /></pre><div class="p1"><br /></div><div class="p1"><br /></div><div class="p1">Trying to remove the oldest one of these gives the error below</div><div class="p1"><br /></div><pre class="brush:bash">sudo apt-get purge linux-image-3.2.0-41-generic<br />Reading package lists... Done<br />Building dependency tree       <br />Reading state information... Done<br />You might want to run 'apt-get -f install' to correct these:<br />The following packages have unmet dependencies:<br /> linux-server : Depends: linux-headers-server (= 3.2.0.55.65) but 3.2.0.60.71 is to be installed<br />E: Unmet dependencies. Try 'apt-get -f install' with no packages (or specify a solution).<br /></pre><div class="p1"><br />Get the current kernel and take note!</div><div class="p1"><br /></div><pre class="brush:bash">uname -r<br />3.2.0-54-generic<br /></pre><div class="p1"><br /></div><div class="p1">Make sure you don't remove this image!</div><div class="p1"><br /></div><div class="p1"></div><div class="p1"><pre class="brush:bash">sudo dpkg -r linux-image-3.2.0-41-generic<br /></pre></div><div class="p1"><br /></div><div class="p1">and</div><div class="p1"><br /></div><div class="p1"></div><pre class="brush:bash">sudo dpkg --purge linux-image-3.2.0-41-generic<br /></pre><div class="p1"><br /></div><div class="p1">Do this for a few of the older versions and you should have space again on the /boot partition<br /><br />But you will now probably get&nbsp;</div><div class="p1"></div> <pre class="brush:bash"><br />sudo apt-get -f install<br />Setting up linux-image-server (3.2.0.60.71) ...<br />dpkg: dependency problems prevent configuration of linux-server:<br /> linux-server depends on linux-image-server (= 3.2.0.55.65); however:<br />  Version of linux-image-server on system is 3.2.0.60.71.<br /> linux-server depends on linux-headers-server (= 3.2.0.55.65); however:<br />  Version of linux-headers-server on system is 3.2.0.60.71.<br />dpkg: error processing linux-server (--configure):<br /> dependency problems - leaving unconfigured<br />No apport report written because the error message indicates its a followup error from a previous failure.<br />                                                                                 Errors were encountered while processing:<br /> linux-server<br />E: Sub-process /usr/bin/dpkg returned an error code (1)<br /></pre><div class="p1"><br />I'm not admin as you may have guessed but it's a virtual server and I took a snapshot, anyway time to get nuclear on it.<br /><br /></div><pre class="brush:bash">sudo dpkg --remove --force-remove-reinstreq linux-image-server<br />sudo dpkg --remove --force-remove-reinstreq linux-headers-server<br />sudo dpkg --remove --force-remove-reinstreq linux-server<br /></pre><div class="p1"></div><div class="p1"><br /></div><div class="p1">Then run -f install again</div><div class="p1"><br /></div><div class="p1"></div><pre class="brush:bash">sudo apt-get -f install<br />Reading package lists... Done<br />Building dependency tree       <br />Reading state information... Done<br />The following packages were automatically installed and are no longer required:<br />  linux-headers-3.2.0-44-generic linux-headers-3.2.0-52-generic linux-headers-3.2.0-41 linux-headers-3.2.0-43 linux-headers-3.2.0-44 linux-headers-3.2.0-45 linux-headers-3.2.0-51 linux-headers-3.2.0-52 linux-headers-3.2.0-53<br />  linux-headers-3.2.0-48 linux-headers-3.2.0-45-generic linux-headers-3.2.0-53-generic linux-headers-3.2.0-48-generic linux-headers-3.2.0-43-generic linux-headers-3.2.0-51-generic linux-headers-3.2.0-41-generic<br />Use 'apt-get autoremove' to remove them.<br />0 upgraded, 0 newly installed, 0 to remove and 130 not upgraded.<br /></pre><div class="p1"><br /></div><div class="p1">Progress at last, clean up the old packages by following it's recommendation</div><div class="p1"></div><pre class="brush:bash">sudo apt-get autoremove<br /><br /><br /></pre><div class="p1">Try the install again </div><pre class="brush:bash">sudo apt-get -f install<br />Reading package lists... Done<br />Building dependency tree       <br />Reading state information... Done<br />0 upgraded, 0 newly installed, 0 to remove and 130 not upgraded.<br /></pre><div class="p1"><br />You should now be in a happy state again, I found the below which should purge all the remaining old images, you might need to modify it if you want to keep more than the current</div><pre class="brush:bash">sudo apt-get purge $(dpkg -l linux-{image,headers}-"[0-9]*" | awk '/ii/{print $2}' | grep -ve "$(uname -r | sed -r 's/-[a-z]+//')")<br /></pre><div class="p1"><br />Should be back to normal now and can perform ann update and upgrade.</div><pre class="brush:bash">sudo apt-get update<br /><br />sudo apt-get upgrade<br /></pre><div class="p1"><br /></div>