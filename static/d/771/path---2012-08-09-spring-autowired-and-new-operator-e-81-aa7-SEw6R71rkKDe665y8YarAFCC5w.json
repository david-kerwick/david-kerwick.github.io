{"data":{"site":{"siteMetadata":{"title":"Random Stuff About Stuff","author":"David Kerwick"}},"markdownRemark":{"id":"4206090a-70ef-5663-9295-83358fe60208","excerpt":"So there I was happily shooting the breeze and added @Autowired to things like it was going out of fashion.  But I then added it to a normal bean, which I was…","html":"<p>So there I was happily shooting the breeze and added @Autowired to things like it was going out of fashion.  But I then added it to a normal bean, which I was creating using the new operator in a RowMapper. Something like this  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyBeanMapper</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">RowMapper</span> <span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MyBean</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">{</span>  \n\n  <span class=\"token annotation punctuation\">@Override</span>  \n  <span class=\"token keyword\">public</span> <span class=\"token class-name\">CapSumLineBean</span> <span class=\"token function\">mapRow</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ResultSet</span> resultSet<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> rowNum<span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token class-name\">SQLException</span> <span class=\"token punctuation\">{</span>  \n\n    <span class=\"token class-name\">MyBean</span> myBean <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyBean</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    myBean<span class=\"token punctuation\">.</span><span class=\"token function\">setParam1</span><span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"param1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    myBean<span class=\"token punctuation\">.</span><span class=\"token function\">setParam1</span><span class=\"token punctuation\">(</span>resultSet<span class=\"token punctuation\">.</span><span class=\"token function\">getString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"param1\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">return</span> myBean<span class=\"token punctuation\">;</span>  \n  <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And MyBean looks something like  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">MyBean</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">Serializable</span>  \n<span class=\"token punctuation\">{</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token keyword\">long</span> serialVersionUID <span class=\"token operator\">=</span> <span class=\"token number\">1L</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token annotation punctuation\">@Autowired</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">transient</span> <span class=\"token class-name\">SomeUtil</span> someUtil<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> param1<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> param2<span class=\"token punctuation\">;</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getParam1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> someUtil<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>param1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setParam1</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> param1<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>param1 <span class=\"token operator\">=</span> param1<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getParam2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>param2<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">setParam2</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">String</span> param2<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  \n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>param2 <span class=\"token operator\">=</span> param2<span class=\"token punctuation\">;</span>  \n    <span class=\"token punctuation\">}</span>  \n<span class=\"token punctuation\">}</span>  </code></pre></div>\n<p>So when you call getParam1 you will get a <code class=\"language-text\">NullPointerException</code> because the <code class=\"language-text\">@Autowired</code> didn’t do anything.  It didn’t do anything because this bean was created by me and not Spring and for <code class=\"language-text\">@Autowired</code> or any of its mates to work the bean must be Spring managed which something created by the new operator generally isn’t.  </p>\n<h2>Getting MyBean Spring Managed</h2>\n<p>So ‘simple’ solution, make the bean one that’s managed by Spring.  A bit of googling and  I could create a factory class to produce these objects and tie that factory into Spring so the beans produced are Spring managed.  That seems clunky to me at the time, it may be the best approach as I started down the rabbit hole with the next bit.  </p>\n<h3>It’s easy just use @Configurable</h3>\n<p>Found this<br>\n<a href=\"http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-atconfigurable\">http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-atconfigurable</a><br>\nAdd an annotation and some config and Spring will catch the new operator operation and do it’s magic, or something like that general Aspect Voodoo happens anyway.  </p>\n<p>Right… it’s never that easy I added <code class=\"language-text\">@Configurable</code> to MyBean and added<br>\n<code class=\"language-text\">&lt;context:spring-configured/&gt;</code> to my root-context.xml and I get the error  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span><span class=\"token class-name\">ClassNotFoundException</span><span class=\"token operator\">:</span> org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>beans<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span>aspectj<span class=\"token punctuation\">.</span><span class=\"token class-name\">AnnotationBeanConfigurerAspect</span>   </code></pre></div>\n<p>Time to check the dependencies I already had  </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.aspectj<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>aspectjrt<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${org.aspectj-version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>cglib<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>cglib<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${cglib.version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Which brought in spring-aop So I added  </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.springframework<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>spring-aspects<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>  \n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${org.springframework-version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>  </code></pre></div>\n<p>Which stopped the errors anyway<br>\nBut still getting the NullPointerException<br>\nFound something which suggested adding in<br>\n<code class=\"language-text\">&lt;context:annotation-config /&gt;</code>\nWhich did no harm but didn’t solve anything<br>\nNext discovered was that <code class=\"language-text\">@Configurable</code> needs load time weaving, thought I had that I’m sure STS asked me about it, must have been compile time weaving?<br>\nAnyway I added in<br>\n<code class=\"language-text\">&lt;context:load-time-weaver/&gt;</code>\nWhich resulted in  </p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span><span class=\"token class-name\">IllegalStateException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">ClassLoader</span> <span class=\"token punctuation\">[</span>org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>loader<span class=\"token punctuation\">.</span><span class=\"token class-name\">WebappClassLoader</span><span class=\"token punctuation\">]</span> does NOT provide an <span class=\"token string\">'addTransformer(ClassFileTransformer)'</span> method<span class=\"token punctuation\">.</span> <span class=\"token class-name\">Specify</span> a custom <span class=\"token class-name\">LoadTimeWeaver</span> or start your <span class=\"token class-name\">Java</span> virtual machine <span class=\"token keyword\">with</span> <span class=\"token class-name\">Spring</span>'s agent<span class=\"token operator\">:</span> <span class=\"token operator\">-</span>javaagent<span class=\"token operator\">:</span>org<span class=\"token punctuation\">.</span>springframework<span class=\"token punctuation\">.</span>instrument<span class=\"token punctuation\">.</span>jar  </code></pre></div>\n<p>Turns out Tomcat isn’t that happy about load time weaving<br>\n<a href=\"http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-aj-ltw-environments\">http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/aop.html#aop-aj-ltw-environments</a><br>\nI got the jar from<br>\n<a href=\"http://mvnrepository.com/artifact/org.springframework/spring-instrument-tomcat\">http://mvnrepository.com/artifact/org.springframework/spring-instrument-tomcat</a><br>\nAnd added it into <span class=\"emphasis\"><em>$CATALINA</em>HOME_</span>/lib<br>\nI went blunderbuss and added  </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>Loader</span> <span class=\"token attr-name\">loaderClass</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>org.springframework.instrument.classloading.tomcat.TomcatInstrumentableClassLoader<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>  </code></pre></div>\n<p>to the Servers context.xml<br>\nWhich lead to the error</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span><span class=\"token class-name\">IllegalStateException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">LifecycleProcessor</span> not initialized <span class=\"token operator\">-</span> call <span class=\"token string\">'refresh'</span> before invoking lifecycle methods via the context   </code></pre></div>\n<p>Well time to throw more dependencies at this so  </p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>dependency</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>groupId</span><span class=\"token punctuation\">></span></span>org.aspectj<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>groupId</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>artifactId</span><span class=\"token punctuation\">></span></span>aspectjweaver<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>artifactId</span><span class=\"token punctuation\">></span></span>  \n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>version</span><span class=\"token punctuation\">></span></span>${org.aspectj-version}<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>version</span><span class=\"token punctuation\">></span></span>  \n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>dependency</span><span class=\"token punctuation\">></span></span>  </code></pre></div>\n<p>And it works!  </p>\n<h3>Conclusion</h3>\n<p>Once setup with the dependencies and config elements <code class=\"language-text\">@Configurable</code> should just work like the rest of the magic annotations all be it there’s more Aspect Voodoo going on.  All in all it might be worth considering the factory option but this should be cleaner… I probably need to revisit the config and take out what’s not needed and I just started adding things in to try get it to work.</p>","frontmatter":{"title":"Spring @Autowired and the new operator","date":"August 09, 2012"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2012-08-09-spring-autowired-and-new-operator/","previous":{"fields":{"slug":"/2012-05-03-get-prettify-to-behave-in-firefox/"},"frontmatter":{"title":"Get prettify to behave in Firefox"}},"next":{"fields":{"slug":"/2014-02-07-syntax-highlighter-and-blogger-dynamic/"},"frontmatter":{"title":"Syntax Highlighter and Blogger Dynamic Views"}}}}