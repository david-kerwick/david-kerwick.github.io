{"data":{"site":{"siteMetadata":{"title":"Random Stuff About Stuff","author":"David Kerwick"}},"markdownRemark":{"id":"44a1e1a7-1f4d-52fb-9fb9-bb9e59619fdb","excerpt":"I’m in the process of trying out a Tomcat server that’s running JDK 11 and rather than deal with multiple VM’s on my machine for the moment I want to try the…","html":"<p>I’m in the process of trying out a Tomcat server that’s running JDK 11 and rather than deal with multiple VM’s on my machine for the moment I want to try the server out locally in a isolated environment.</p>\n<p>So packaged with Java 8 but running on Java 11.</p>\n<p>To do that Docker made sense. Set up a docker container with Tomcat 9 and JDK 11.</p>\n<h1>Connect IntelliJ to Docker</h1>\n<p>So first is to set up IntelliJ to connect to your docker install, on a Mac this seemed nice and straight forward. Guide <a href=\"https://www.jetbrains.com/help/idea/docker.html\">here</a></p>\n<h1>Deploy app to a container</h1>\n<p>That’s covered <a href=\"https://www.jetbrains.com/help/idea/deploying-a-web-app-into-an-app-server-container.html#7a841cf4\">here</a>. Now the settings for this is where the real fun is. Seems from the interface the ‘Bind Mounts’ are only happy with directories. Having a maven build the war was a file within the target directory, so I created a new artifact that was the war in it’s own directory and has a stable name (i.e. the version isn’t tacked on) the name is the context path so this is handy I think.</p>\n<h1>Container settings</h1>\n<p>Not sure the best way for setting up the settings for Tomcat within the container. The app ran out of memory straight away so first port of call was adding <code class=\"language-text\">JAVA_OPTS</code> to the environment variables section.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token operator\">-</span><span class=\"token class-name\">Xss64m</span></code></pre></div>\n<p>Next was setting up a database connection, this seemed less clean. I added a volume mount for the whole config directory using the settings copied from a local install. So that’s</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\">&lt;LOCAL PATH<span class=\"token punctuation\">></span><span class=\"token punctuation\">:</span>/usr/local/tomcat/conf/</code></pre></div>\n<p>It then needs the driver (in this case Oracle). Rather than mount the whole lib folder which seems like the only option under Bind Mounts I added a volume definition to the Run Options section</p>\n<div class=\"gatsby-highlight\" data-language=\"docker\"><pre class=\"language-docker\"><code class=\"language-docker\"><span class=\"token punctuation\">-</span>v /Users/David/oracle/ojdbc8.jar<span class=\"token punctuation\">:</span>/usr/local/tomcat/lib/ojdbc8.jar</code></pre></div>\n<p>So started getting there now. For some reason it failed with a TimeZone error</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token number\">16</span><span class=\"token operator\">-</span><span class=\"token class-name\">Apr</span><span class=\"token operator\">-</span><span class=\"token number\">2019</span> <span class=\"token number\">13</span><span class=\"token operator\">:</span><span class=\"token number\">26</span><span class=\"token operator\">:</span><span class=\"token number\">23.937</span> WARNING <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span> org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span>lookup <span class=\"token class-name\">Unexpected</span> exception resolving reference\n java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span><span class=\"token class-name\">SQLException</span><span class=\"token operator\">:</span> <span class=\"token class-name\">Cannot</span> create <span class=\"token class-name\">PoolableConnectionFactory</span> <span class=\"token punctuation\">(</span>ORA<span class=\"token operator\">-</span><span class=\"token number\">00604</span><span class=\"token operator\">:</span> error occurred at recursive SQL level <span class=\"token number\">1</span>\nORA<span class=\"token operator\">-</span><span class=\"token number\">01882</span><span class=\"token operator\">:</span> timezone region  not found\n<span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>tomcat<span class=\"token punctuation\">.</span>dbcp<span class=\"token punctuation\">.</span>dbcp2<span class=\"token punctuation\">.</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span><span class=\"token function\">createPoolableConnectionFactory</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">735</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>tomcat<span class=\"token punctuation\">.</span>dbcp<span class=\"token punctuation\">.</span>dbcp2<span class=\"token punctuation\">.</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span><span class=\"token function\">createDataSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">605</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>tomcat<span class=\"token punctuation\">.</span>dbcp<span class=\"token punctuation\">.</span>dbcp2<span class=\"token punctuation\">.</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span><span class=\"token function\">getLogWriter</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BasicDataSource</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">1110</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>tomcat<span class=\"token punctuation\">.</span>dbcp<span class=\"token punctuation\">.</span>dbcp2<span class=\"token punctuation\">.</span><span class=\"token class-name\">BasicDataSourceFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">createDataSource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BasicDataSourceFactory</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">554</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>tomcat<span class=\"token punctuation\">.</span>dbcp<span class=\"token punctuation\">.</span>dbcp2<span class=\"token punctuation\">.</span><span class=\"token class-name\">BasicDataSourceFactory</span><span class=\"token punctuation\">.</span><span class=\"token function\">getObjectInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">BasicDataSourceFactory</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">236</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span>factory<span class=\"token punctuation\">.</span><span class=\"token class-name\">FactoryBase</span><span class=\"token punctuation\">.</span><span class=\"token function\">getObjectInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">FactoryBase</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">94</span><span class=\"token punctuation\">)</span>\n\tat java<span class=\"token punctuation\">.</span>naming<span class=\"token operator\">/</span>javax<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span>spi<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingManager</span><span class=\"token punctuation\">.</span><span class=\"token function\">getObjectInstance</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingManager</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">325</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">840</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">159</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">827</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>naming<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span><span class=\"token function\">lookup</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContext</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">173</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span><span class=\"token function\">addResource</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">1017</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span><span class=\"token function\">createNamingContext</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">557</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span><span class=\"token function\">lifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NamingContextListener</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">253</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span><span class=\"token class-name\">LifecycleBase</span><span class=\"token punctuation\">.</span><span class=\"token function\">fireLifecycleEvent</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleBase</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">123</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>core<span class=\"token punctuation\">.</span><span class=\"token class-name\">StandardServer</span><span class=\"token punctuation\">.</span><span class=\"token function\">startInternal</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">StandardServer</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">920</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>util<span class=\"token punctuation\">.</span><span class=\"token class-name\">LifecycleBase</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">LifecycleBase</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">183</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>startup<span class=\"token punctuation\">.</span><span class=\"token class-name\">Catalina</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Catalina</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">634</span><span class=\"token punctuation\">)</span>\n\tat java<span class=\"token punctuation\">.</span>base<span class=\"token operator\">/</span>jdk<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span><span class=\"token class-name\">NativeMethodAccessorImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke0</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Native</span> <span class=\"token class-name\">Method</span><span class=\"token punctuation\">)</span>\n\tat java<span class=\"token punctuation\">.</span>base<span class=\"token operator\">/</span>jdk<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span><span class=\"token class-name\">NativeMethodAccessorImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NativeMethodAccessorImpl</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">62</span><span class=\"token punctuation\">)</span>\n\tat java<span class=\"token punctuation\">.</span>base<span class=\"token operator\">/</span>jdk<span class=\"token punctuation\">.</span>internal<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span><span class=\"token class-name\">DelegatingMethodAccessorImpl</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">DelegatingMethodAccessorImpl</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">43</span><span class=\"token punctuation\">)</span>\n\tat java<span class=\"token punctuation\">.</span>base<span class=\"token operator\">/</span>java<span class=\"token punctuation\">.</span>lang<span class=\"token punctuation\">.</span>reflect<span class=\"token punctuation\">.</span><span class=\"token class-name\">Method</span><span class=\"token punctuation\">.</span><span class=\"token function\">invoke</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Method</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">566</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>startup<span class=\"token punctuation\">.</span><span class=\"token class-name\">Bootstrap</span><span class=\"token punctuation\">.</span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bootstrap</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">350</span><span class=\"token punctuation\">)</span>\n\tat org<span class=\"token punctuation\">.</span>apache<span class=\"token punctuation\">.</span>catalina<span class=\"token punctuation\">.</span>startup<span class=\"token punctuation\">.</span><span class=\"token class-name\">Bootstrap</span><span class=\"token punctuation\">.</span><span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Bootstrap</span><span class=\"token punctuation\">.</span>java<span class=\"token operator\">:</span><span class=\"token number\">492</span><span class=\"token punctuation\">)</span>\n<span class=\"token class-name\">Caused</span> by<span class=\"token operator\">:</span> java<span class=\"token punctuation\">.</span>sql<span class=\"token punctuation\">.</span><span class=\"token class-name\">SQLException</span><span class=\"token operator\">:</span> ORA<span class=\"token operator\">-</span><span class=\"token number\">00604</span><span class=\"token operator\">:</span> error occurred at recursive SQL level <span class=\"token number\">1</span>\nORA<span class=\"token operator\">-</span><span class=\"token number\">01882</span><span class=\"token operator\">:</span> timezone region  not found</code></pre></div>\n<p>Must be something different from the local setting and the docker setup, back to <code class=\"language-text\">JAVA_OPTS</code> and add <code class=\"language-text\">-Duser.timezone=GMT</code></p>\n<h1>Success</h1>\n<p>So it now runs and I can attempt to hammer the app config until it’s happy to run on 8 and 11 as we transition. The thing is though a Spring Boot application runs <strong>very very slowly</strong> way slower than if it was a local install.  I haven’t nailed it yet but some of these magic sauce options make it better but not great.  Added to <code class=\"language-text\">JAVA_OPTS</code></p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\">JAVA_OPTS<span class=\"token operator\">=</span><span class=\"token operator\">-</span>XX<span class=\"token operator\">:</span><span class=\"token class-name\">MaxMetaspaceSize</span>\\<span class=\"token operator\">=</span><span class=\"token number\">512</span>m <span class=\"token operator\">-</span><span class=\"token class-name\">Xmx512m</span> <span class=\"token operator\">-</span><span class=\"token class-name\">Xss512m</span> <span class=\"token operator\">-</span><span class=\"token class-name\">Djava</span><span class=\"token punctuation\">.</span>security<span class=\"token punctuation\">.</span>egd\\<span class=\"token operator\">=</span>file<span class=\"token operator\">:</span><span class=\"token operator\">/</span>dev<span class=\"token operator\">/</span><span class=\"token punctuation\">.</span>/urandom <span class=\"token operator\">-</span><span class=\"token class-name\">Duser</span><span class=\"token punctuation\">.</span>timezone\\<span class=\"token operator\">=</span>GMT</code></pre></div>\n<p>Random is a known performance problem as there just isn’t enough entropy in the container. Normal warnings apply to urandom (it isn’t full secure) but the performance on startup is still pretty poor.</p>\n<p><strong>Update</strong></p>\n<p>So it seems the slowness is a known <a href=\"https://forums.docker.com/t/file-access-in-mounted-volumes-extremely-slow-cpu-bound/8076/\">issue</a> and it’s to do with Docker on the Mac, Spring and Tomcat are innocent I tried the cached setting explained <a href=\"https://blog.docker.com/2017/05/user-guided-caching-in-docker-for-mac/\">here</a> but it made no real difference. If you copy the war into a new image and run that container it extremely fast, but that seems like quite the pain.</p>\n<p><strong>Further update</strong></p>\n<p>So in the end what worked is to volume mount the war file to a file in the webapps folder. You can’t do this using the bind mounts as mentioned above so add it to the Run Options. It now starts in about 2 seconds as opposed to 25 plus</p>","frontmatter":{"title":"IntelliJ working with a Tomcat Docker container","date":"April 16, 2019"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/2019-04-16-intellij-tomcat-in-docker-container/","previous":{"fields":{"slug":"/2019-04-15-moving-to-gatsby/"},"frontmatter":{"title":"Moving Blog to Gatsby"}},"next":{"fields":{"slug":"/2019-04-18-sonarqube-missing-test-coverage/"},"frontmatter":{"title":"Sonarqube missing Integration Test coverage"}}}}